"use strict";var A="RESET_TO_INITIAL";var h="state-machine",v="interaction_";function E(e){if(typeof e=="string")return e;if(e&&typeof e=="object"){let n=e;return"value"in n?String(n.value):"name"in n?String(n.name):String(e)}return String(e)}function u(e,n,o){figma.ui.postMessage({type:e,data:n,message:o})}function P(e,n){let o=e instanceof Error?e.message:"Unknown error";console.error(`${n}:`,e),u("error",null,`${n}: ${o}`)}function T(e){let n=[];function o(t){if(t.type==="INSTANCE"&&n.push(t),"children"in t)for(let r of t.children)o(r)}if("children"in e)for(let t of e.children)o(t);return n}async function _(e){let n=new Map;for(let o of e){let t=await o.getMainComponentAsync();if(!t)continue;let r=t.parent,s,a;r&&r.type==="COMPONENT_SET"?(s=r.id,a=r.name):(s=t.id,a=t.name),n.has(s)||n.set(s,{id:s,name:a,instances:[],states:[],properties:{}});let i=n.get(s);if(i.instances.push(o),o.componentProperties&&r&&r.type==="COMPONENT_SET"){let f=r;for(let[p,c]of Object.entries(o.componentProperties))if(i.properties[p]||(i.properties[p]=[]),f.componentPropertyDefinitions){let m=f.componentPropertyDefinitions[p];m&&m.type==="VARIANT"&&m.variantOptions&&m.variantOptions.forEach(l=>{i.properties[p].includes(l)||i.properties[p].push(l)})}}}return Array.from(n.values())}async function x(e,n){if(n.length===0)return{actualPropertyName:null,isVariantProperty:!1};let t=await n[0].getMainComponentAsync(),r=t==null?void 0:t.parent;if(r&&r.type==="COMPONENT_SET"){let s=r;if(s.componentPropertyDefinitions){for(let[a,i]of Object.entries(s.componentPropertyDefinitions))if(i.type==="VARIANT"&&(a===e||a.toLowerCase()===e.toLowerCase()))return{actualPropertyName:a,isVariantProperty:!0}}}return{actualPropertyName:null,isVariantProperty:!1}}var d=null;async function N(){try{d=(await figma.variables.getLocalVariableCollectionsAsync()).find(n=>n.name===h)||null,d||(d=figma.variables.createVariableCollection(h))}catch(e){console.error("Error setting up variable collection:",e)}}async function R(e,n,o,t){if(!d)throw new Error("Variable collection not initialized");let r=[],s=[];for(let a=0;a<n.instances.length;a++){let i=n.instances[a],f=figma.variables.createVariable(`${e.id}_instance_${a}_${t}`,d,"STRING"),p="";if(i.componentProperties&&i.componentProperties[o]){let c=i.componentProperties[o];p=E(c)}s.push(p),f.setValueForMode(d.defaultModeId,p),r.push(f);try{let c=figma.variables.createVariableAlias(f),m={};m[o]=c,i.setProperties(m)}catch(c){console.error(`Failed to bind variable to instance ${a+1}:`,c)}}return{instanceVars:r,originalStates:s}}async function L(){try{let e=await figma.variables.getLocalVariablesAsync(),o=(await figma.variables.getLocalVariableCollectionsAsync()).find(i=>i.name===h);if(!o)return;let t=e.filter(i=>i.variableCollectionId===o.id);if(t.length===0)return;let r=new Set,s=figma.currentPage.findAll();for(let i of s)if("reactions"in i&&i.reactions){for(let f of i.reactions)if(f.actions)for(let p of f.actions)p.type==="SET_VARIABLE"&&p.variableId&&r.add(p.variableId)}let a=0;for(let i of t)if(!r.has(i.id))try{i.remove(),a++}catch(f){console.error(`Failed to remove variable "${i.name}":`,f)}console.log(`Removed ${a} orphaned variables`)}catch(e){console.error("Error during comprehensive cleanup:",e)}}async function O(e){if(d)try{let n=await figma.variables.getLocalVariablesAsync();for(let o of n)o.variableCollectionId===d.id&&o.name.startsWith(e)&&o.remove()}catch(n){console.error("Error during cleanup:",n)}}async function M(e){if(!d)throw new Error("Variable collection not initialized");let n=e.id,o=`${n}_primary`,t=figma.variables.createVariable(o,d,"BOOLEAN");t.setValueForMode(d.defaultModeId,!1);let r=[];for(let s=0;s<e.conditionalRules.length;s++){let a=`${n}_conditional_${s}`,i=figma.variables.createVariable(a,d,"BOOLEAN");i.setValueForMode(d.defaultModeId,!1),r.push(i)}return{primaryVar:t,conditionalVars:r}}async function $(e){try{let n=`${v}${e.component}`;await figma.clientStorage.setAsync(n,JSON.stringify(e))}catch(n){console.error("Error storing interaction data:",n)}}async function K(e){try{let n=`${v}${e}`,o=await figma.clientStorage.getAsync(n);if(o)return JSON.parse(o)}catch(n){console.error("Error retrieving interaction data:",n)}return null}async function D(e){try{for(let n of e){let o=`${v}${n.id}`;await figma.clientStorage.deleteAsync(o)}}catch(n){console.error("Error cleaning up stored interactions:",n)}}async function B(e){let n={};for(let o of e){let t=await K(o.id);t&&(n[o.id]=t)}return n}var w=[],H=[];function U(e){w=e}function S(){return w}async function k(e){var n;try{await N(),await O(e.id);let{primaryVar:o,conditionalVars:t}=await M(e);H.push(e),await $(e),await j(e,o,t);let r=((n=w.find(s=>s.id===e.component))==null?void 0:n.name)||"Unknown Component";u("interaction-created",null,`Interaction created successfully for ${r}`)}catch(o){let t=o instanceof Error?o.message:"Unknown error";u("error",null,`Failed to create interaction: ${t}`)}}async function j(e,n,o){try{let t=w.find(c=>c.id===e.component);if(!t)return;let[r,s]=e.primaryAction.split("="),{actualPropertyName:a,isVariantProperty:i}=await x(r,t.instances),f=[],p=[];if(a&&i){let c=await R(e,t,a,r);f=c.instanceVars,p=c.originalStates}for(let c=0;c<t.instances.length;c++){let m=t.instances[c];try{await m.setReactionsAsync([])}catch(l){console.error(`Failed to clear reactions on instance ${c+1}:`,l)}}for(let c=0;c<t.instances.length;c++){let m=t.instances[c];try{if(a&&i&&f.length>0)await z(m,c,e,t,f,p,r,s);else{let l={trigger:{type:"ON_CLICK"},actions:[]};await m.setReactionsAsync([l])}}catch(l){console.error(`Failed to apply reaction to ${m.name}:`,l)}}}catch(t){console.error("Error applying interaction to instances:",t)}}async function z(e,n,o,t,r,s,a,i){let f=[{type:"SET_VARIABLE",variableId:r[n].id,variableValue:{resolvedType:"STRING",type:"STRING",value:String(i)}}],p=new Map,c=null;for(let l of o.conditionalRules){if(!l.condition||!l.action||!l.condition.includes("="))continue;let[y,b]=l.condition.split("="),g=l.action;(y===a||y.toLowerCase()===a.toLowerCase())&&(p.set(b,g),b===i&&(c=g))}for(let l=0;l<t.instances.length;l++){if(n===l)continue;let y=t.instances[l],b="";if(y.componentProperties&&y.componentProperties[a]){let I=y.componentProperties[a];b=E(I)}let g=s[l],V=!1;if(p.has(b)){let I=p.get(b);if(I===A)g=s[l],V=!0;else if(I.includes("=")){let[C,G]=I.split("=");(C===a||C.toLowerCase()===a.toLowerCase())&&(g=G,V=!0)}}if(!V&&c){if(c===A)g=s[l],V=!0;else if(c.includes("=")){let[I,C]=c.split("=");(I===a||I.toLowerCase()===a.toLowerCase())&&(g=C,V=!0)}}V||(g=s[l]),f.push({type:"SET_VARIABLE",variableId:r[l].id,variableValue:{resolvedType:"STRING",type:"STRING",value:String(g)}})}let m={trigger:{type:"ON_CLICK"},actions:f};await e.setReactionsAsync([m])}figma.showUI(__html__,{width:800,height:600});figma.on("selectionchange",async()=>{u("selection-changed",null,"Analyzing new selection..."),await F()});figma.ui.onmessage=async e=>{try{switch(e.type){case"init":await F();break;case"create-interaction":await k(e.data);break;case"get-components":u("components-data",S());break;case"cleanup":await L(),u("cleanup-complete",null,"Comprehensive cleanup completed successfully");break;case"cleanup-stored-data":await D(S()),u("cleanup-complete",null,"Stored interaction data cleaned up successfully");break;case"cancel":figma.closePlugin();break;default:console.log("Unknown message type:",e.type)}}catch(n){P(n,"Message handler")}};async function F(){try{let e=figma.currentPage.selection;if(e.length!==1){u("error",null,"Please select exactly one component instance.");return}let n=e[0];if(n.type!=="INSTANCE"){u("error",null,"Selected element must be a component instance.");return}let o=T(n);if(o.length===0){u("error",null,"No nested component instances found in selection.");return}let t=await _(o);U(t),await N();let r=await B(t),s={selectedInstance:n.name,components:t,existingInteractions:r};u("init-success",s)}catch(e){P(e,"Initialization failed")}}
//# sourceMappingURL=code.js.map
